@model LaundryOrder

@{
    ViewData["Title"] = "Save Payment Method";
}

<h1 class="mb-3">Save Payment Method</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Order Summary</h5>
            </div>
            <div class="card-body">
                <p><strong>Order #:</strong> @Model.Id</p>
                <p><strong>Service:</strong> @Model.ServiceType</p>
                <p><strong>Date/Time:</strong> @Model.ScheduledAt</p>
                <p><strong>Address:</strong> @Model.GetDisplayAddress()</p>
                @if (!string.IsNullOrWhiteSpace(Model.Notes))
                {
                    <p><strong>Notes:</strong> @Model.Notes</p>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Payment Method</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>No charge today.</strong> Weâ€™ll charge your card only after your laundry is processed and marked Ready.
                </div>

                @if (!(ViewBag.StripeConfigured as bool? ?? false) || string.IsNullOrWhiteSpace(ViewBag.StripePublishableKey as string))
                {
                    <div class="alert alert-warning">
                        Stripe is not configured yet. Set <strong>Stripe:SecretKey</strong> and <strong>Stripe:PublishableKey</strong> in app settings.
                    </div>
                }

                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <div>@err.ErrorMessage</div>
                        }
                    </div>
                }
                
                <form method="post" id="stripeSaveMethodForm" action="/Orders/SavePaymentMethod/@Model.Id">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="setupIntentId" id="setupIntentId" />
                    <input type="hidden" name="paymentMethodId" id="paymentMethodId" />
                    
                    <div class="mb-3">
                        <label class="form-label">Card details</label>
                        <div id="card-element" class="form-control" style="padding-top:12px; padding-bottom:12px;"></div>
                        <small class="text-muted">Your card is saved securely with Stripe for future off-session billing.</small>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="hidden" name="acceptTerms" value="false" />
                        <input type="checkbox" name="acceptTerms" id="acceptTerms" value="true" class="form-check-input" required />
                        <label class="form-check-label" for="acceptTerms">
                            I agree that my card will only be charged when the final total is ready after processing. Payment processing fees may apply. I have reviewed the <a href="/Account/Terms" target="_blank" rel="noopener">Terms and Conditions</a>.
                        </label>
                    </div>
                    
                    <button type="submit" id="saveCardBtn" class="btn btn-primary w-100">Save Card & Continue</button>
                </form>
                
                <div class="mt-3 text-center">
                    <a href="/Orders/Schedule" class="btn btn-outline-secondary">Cancel & Schedule Another</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        (() => {
            const stripePublishableKey = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((ViewBag.StripePublishableKey as string ?? string.Empty).Trim()));
            const stripeConfigured = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.StripeConfigured as bool? ?? false));
            if (!stripeConfigured || !stripePublishableKey) {
                return;
            }

            const form = document.getElementById('stripeSaveMethodForm');
            const submitBtn = document.getElementById('saveCardBtn');
            const setupIntentIdInput = document.getElementById('setupIntentId');
            const paymentMethodIdInput = document.getElementById('paymentMethodId');
            const cardElementContainer = document.getElementById('card-element');

            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();
            const cardElement = elements.create('card', { hidePostalCode: true });
            cardElement.mount(cardElementContainer);

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving card...';

                try {
                    const setupIntentResp = await fetch('/api/billing/setup-intent', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });

                    if (!setupIntentResp.ok) {
                        throw new Error('Unable to initialize secure card setup.');
                    }

                    const setupIntentPayload = await setupIntentResp.json();
                    const clientSecret = setupIntentPayload.clientSecret;
                    if (!clientSecret) {
                        throw new Error('Missing setup intent secret from server.');
                    }

                    const result = await stripe.confirmCardSetup(clientSecret, {
                        payment_method: {
                            card: cardElement
                        }
                    });

                    if (result.error) {
                        throw new Error(result.error.message || 'Unable to save card.');
                    }

                    const setupIntent = result.setupIntent;
                    setupIntentIdInput.value = setupIntent.id;
                    paymentMethodIdInput.value = setupIntent.payment_method;

                    form.submit();
                } catch (error) {
                    alert(error.message || 'Unable to save card right now. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        })();
    </script>
}
